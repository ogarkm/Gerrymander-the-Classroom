<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Command Center</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" type="image/png" href="/logo" />
    <style>
        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.7); 
            backdrop-filter: blur(5px);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 12px;
            width: 350px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: var(--text-color);
        }
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .close-modal {
            color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;
            margin-top: -15px; margin-right: -10px;
        }
        .close-modal:hover { color: var(--accent-color); }
        .qr-wrapper { margin: 20px auto; padding: 10px; background: white; border-radius: 8px; width: fit-content; }
        .share-link {
            background: var(--neutral-bg); padding: 10px; border-radius: 6px;
            word-break: break-all; margin-top: 15px; font-family: monospace;
            border: 1px solid var(--border-color);
        }
        .header-btn {
            background: var(--accent-color); color: white; border: none; padding: 8px 16px; 
            border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;
            display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .header-btn:hover { opacity: 0.9; transform: translateY(-1px); }
    </style>
</head>
<body class="admin-view">

<!-- SHARE MODAL -->
<div id="shareModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeShareModal()">&times;</span>
        <h2 style="margin-top:0; color:var(--accent-color)">Join the Game</h2>
        <p>Scan to join:</p>
        <div class="qr-wrapper">
            <img id="qr-code-img" src="" alt="QR Code" width="200" height="200">
        </div>
        <div class="share-link" id="share-link-text"></div>
    </div>
</div>

<div class="game-container admin-container">
    <div class="game-header">
        <div style="display:flex; align-items:center; gap:15px;">
            <h3><i class="fa-solid fa-gamepad"></i> COMMAND CENTER</h3>
            <button class="header-btn" onclick="openShareModal()">
                <i class="fa-solid fa-share-nodes"></i> Share Link
            </button>
        </div>
        <div id="connection-status" style="color: var(--desk-open); font-weight: bold;">
            <i class="fa-solid fa-wifi"></i> Online
        </div>
    </div>

    <div class="dashboard-content">
        <!-- LEADERBOARD CARD -->
        <div class="dash-card area-leaderboard">
            <h3>Live Rankings (Cumulative) <i class="fa-solid fa-trophy"></i></h3>
            <div id="admin-leaderboard"></div>
        </div>

        <!-- MAP CARD -->
        <div class="dash-card area-visual">
            <div class="admin-grid-container">
                <div id="admin-grid" class="classroom-grid"></div>
            </div>
        </div>

        <!-- CONTROLS CARD -->
        <div class="dash-card area-controls">
            <div class="controls-wrapper">
                
                <!-- Game Config -->
                <div class="ctrl-group" style="flex: 0 0 250px;">
                    <h3>Game Configuration</h3>
                    <select id="round-selector" class="round-select" onchange="changeRound(this.value)">
                        {% for key, val in rounds.items() %}
                        <option value="{{key}}">{{val.question}}</option>
                        {% endfor %}
                    </select>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: auto;">
                        <div class="stat-box">
                            <span class="stat-label">PLAYERS</span>
                            <span class="stat-num" id="stat-players">0</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">TOTAL VOTES</span>
                            <span class="stat-num" id="total-votes">0</span>
                        </div>
                    </div>
                </div>

                <!-- Phase Buttons -->
                <div class="ctrl-group">
                    <h3>Phase Control</h3>
                    <div class="btn-grid">
                        <button class="admin-btn" id="btn-login" onclick="setPhase('LOGIN')">
                            <i class="fa-solid fa-door-open fa-lg"></i> LOGIN
                        </button>
                        <button class="admin-btn" id="btn-vote" onclick="setPhase('VOTE')">
                            <i class="fa-solid fa-check-to-slot fa-lg"></i> VOTE
                        </button>
                        <button class="admin-btn" id="btn-game" onclick="setPhase('GAME')">
                            <i class="fa-solid fa-chess-board fa-lg"></i> GAME
                        </button>
                        <button class="admin-btn" id="btn-results" onclick="setPhase('RESULTS')">
                            <i class="fa-solid fa-chart-simple fa-lg"></i> RESULTS
                        </button>
                    </div>
                </div>

                <!-- Reset Button -->
                <div class="ctrl-group" style="flex: 0 0 100px;">
                    <h3>System</h3>
                    <div class="btn-grid" style="grid-template-columns: 1fr;">
                        <button class="admin-btn" id="btn-reset" onclick="resetGame()" style="background: rgba(231, 76, 60, 0.1); border-color: var(--desk-taken);">
                            <i class="fa-solid fa-power-off fa-lg" style="color: var(--desk-taken)"></i> <span style="color:var(--desk-taken)">RESET</span>
                        </button>
                    </div>
                </div>

                <!-- Live Votes -->
                <div class="ctrl-group" style="flex: 0 0 220px;">
                    <h3>Live Polling</h3>
                    <div class="stat-box" style="border-left: 4px solid var(--party-a-color); margin-bottom: 10px;">
                        <span class="stat-label" id="label-a">Option A</span>
                        <span class="stat-num col-a" id="stat-a">0</span>
                    </div>
                    <div class="stat-box" style="border-left: 4px solid var(--party-b-color);">
                        <span class="stat-label" id="label-b">Option B</span>
                        <span class="stat-num col-b" id="stat-b">0</span>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // SECURE PROTOCOL HANDLING
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${protocol}//${window.location.host}/ws/admin`);
    
    const TOTAL_SEATS = 30;
    const root = document.documentElement;

    ws.onopen = () => {
        console.log("Admin Connected");
        document.getElementById("connection-status").innerHTML = '<i class="fa-solid fa-wifi"></i> Online';
        document.getElementById("connection-status").style.color = 'var(--desk-open)';
    };

    ws.onclose = () => {
        document.getElementById("connection-status").innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Offline';
        document.getElementById("connection-status").style.color = 'var(--desk-taken)';
    };
    
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "admin_update") {
            updateUI(data);
        }
    };

    function setPhase(phase) {
        ws.send(JSON.stringify({ type: "set_phase", phase: phase }));
    }

    function changeRound(roundId) {
        if(confirm("Changing the round will reset current votes. Continue?")) {
            ws.send(JSON.stringify({ type: "set_round", round_id: roundId }));
        }
    }

    function resetGame() {
        if(confirm("âš  DANGER: This will KICK ALL PLAYERS and RESET scores. Continue?")) {
            ws.send(JSON.stringify({ type: "reset_game" }));
        }
    }

    // --- SHARE FUNCTIONALITY ---
    function openShareModal() {
        const modal = document.getElementById("shareModal");
        const linkText = document.getElementById("share-link-text");
        const img = document.getElementById("qr-code-img");
        
        // Use the origin (protocol + host)
        const joinLink = window.location.origin;
        
        linkText.innerText = joinLink;
        
        // Use QR Server API
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(joinLink)}`;
        img.src = qrUrl;
        
        modal.style.display = "flex";
    }

    function closeShareModal() {
        document.getElementById("shareModal").style.display = "none";
    }

    // Close modal on outside click
    window.onclick = function(event) {
        if (event.target == document.getElementById("shareModal")) {
            closeShareModal();
        }
    }

    function updateUI(data) {
        // 1. Update Config (Colors/Labels)
        if(data.round_info) {
            const r = data.round_info;
            root.style.setProperty('--party-a-color', r.colors[0]);
            root.style.setProperty('--party-b-color', r.colors[1]);
            
            document.getElementById("label-a").innerText = r.options[0];
            document.getElementById("label-b").innerText = r.options[1];
            document.getElementById("round-selector").value = data.round_id;
        }

        // 2. Update Buttons
        document.querySelectorAll('.admin-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${data.phase.toLowerCase()}`).classList.add('active');

        // 3. Update Stats
        document.getElementById("stat-players").innerText = data.player_count;
        
        const opts = data.round_info.options;
        const valA = data.votes[opts[0]] || 0;
        const valB = data.votes[opts[1]] || 0;
        
        document.getElementById("stat-a").innerText = valA;
        document.getElementById("stat-b").innerText = valB;
        document.getElementById("total-votes").innerText = valA + valB;

        // 4. Render Leaderboard
        const lb = document.getElementById("admin-leaderboard");
        lb.innerHTML = "";
        data.players.forEach((p, index) => {
            const row = document.createElement("div");
            row.className = "lb-row"; 
            
            if (!p.online) row.style.opacity = "0.5";

            let borderColor = 'transparent';
            if (index === 0) borderColor = '#eab308';
            else if (index === 1) borderColor = '#94a3b8';
            else if (index === 2) borderColor = '#b45309';
            row.style.borderLeft = `4px solid ${borderColor}`;
            
            row.innerHTML = `
                <div>
                    <span style="color:#777; margin-right:8px">#${index+1}</span> ${p.name}
                    ${!p.online ? '<i class="fa-solid fa-plug-circle-xmark" style="color:red; margin-left:5px"></i>' : ''}
                </div>
                <span class="score-val">${p.total_score}%</span>
            `;
            lb.appendChild(row);
        });

        // 5. Render Grid
        renderAdminGrid(data);
    }

    function renderAdminGrid(data) {
        const grid = document.getElementById("admin-grid");
        grid.innerHTML = "";
        const seatMap = {};
        data.players.forEach((p, idx) => { seatMap[p.seat] = { ...p, rank: idx + 1 }; });

        for (let i = 0; i < TOTAL_SEATS; i++) {
            const s = document.createElement("div");
            s.className = "seat seat-admin"; 
            
            if((i % 6) === 1 || (i % 6) === 3) s.style.marginRight = "20px";
            if(i >= 6 && i < 12) s.style.marginBottom = "20px";
            if(i >= 18 && i < 24) s.style.marginBottom = "20px";

            if (seatMap[i]) {
                s.classList.add("taken");
                s.innerText = seatMap[i].name.replace("Desk #", "");
                
                if(!seatMap[i].online) {
                    s.style.opacity = "0.4";
                    s.style.border = "1px solid red";
                }

                if (data.phase === "RESULTS") {
                    const rank = seatMap[i].rank;
                    if (rank <= 3) {
                        const badge = document.createElement("div");
                        badge.className = "seat-badge";
                        badge.style.background = rank === 1 ? '#eab308' : (rank === 2 ? '#94a3b8' : '#b45309');
                        badge.style.color = 'white';
                        badge.innerText = rank;
                        s.appendChild(badge);
                    }
                }
            } else {
                s.innerText = i + 1;
            }
            grid.appendChild(s);
        }
    }
</script>
</body>
</html>